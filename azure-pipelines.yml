# https://aka.ms/yaml

trigger:
- master
pr:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: coreVariables

steps:
- pwsh: ./runTests.ps1
  displayName: 'Run helper module tests'
  workingDirectory: '$(Build.SourcesDirectory)/Modules/MathshammerHelper/Tests'

- task: PublishTestResults@2
  inputs:
    testResultsFormat: NUnit
    testResultsFiles: '**/TEST-*.xml'
    failTaskOnFailedTests: true
  condition: succeededOrFailed()

- task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@0
  displayName: 'Install terraform'
  inputs:
    terraformVersion: 0.12.8

- task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-cli.TerraformCLI@0
  displayName: 'terraform init'
  inputs:
    command: init
    workingDirectory: '$(Build.SourcesDirectory)/infrastructure/terraform'

- task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-cli.TerraformCLI@0
  displayName: 'terraform validate'
  inputs:
    command: validate
    workingDirectory: '$(Build.SourcesDirectory)/infrastructure/terraform'


- task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-cli.TerraformCLI@0
  displayName: 'terraform apply'
  inputs:
    command: apply
    workingDirectory: '$(Build.SourcesDirectory)/infrastructure/terraform'

- task: AzureCLI@1
  inputs:
    azureSubscription: azure
    scriptLocation: 'scriptPath'
    scriptPath: '$(Build.SourcesDirectory)/infrastructure/runTerraform.sh'
    arguments: '$(Build.SourcesDirectory)/infrastructure $(Build.SourcesDirectory)/infrastructure/terraform'
